<!DOCTYPE html>
<html>
    <head>
        <title>Draw Features</title>
        <link rel="stylesheet" href="http://openlayers.org/en/v3.14.2/css/ol.css" type="text/css">
        <script src="http://openlayers.org/en/v3.14.2/build/ol.js"></script>
    </head>
    <body>
        <div id="map"></div>
        <form class="form-inline">
            <input type="button" id="drawBtn" value="Dibujar area" onclick="drawBox()"/>
            <input type="button" id="clearBtn" value="Limpiar area" onclick="clearLayer()"/>
            <input type="button" id="selectBtn" value="Seleccionar area" onclick="selectFeatures()"/>
        </form>
        <script>
            
            /**
             * Capas Base
             */
            
            /*Creacion capa base Bing Maps Roads*/
            var bmapsRoads = new ol.layer.Tile({
                title: 'BingMaps Roads',
                preload: Infinity,
                source: new ol.source.BingMaps({
                    key: 'AnyGyd4GaAzToU0sDaA0NaXDD88yChcUh8ySoNc32_ddxkrxkl9K5SIATkA8EpMn',
                    imagerySet: 'Road'
                }),
                visible: true
            });
            
            /*Creacion capa base Bing Maps Aerial*/
            var bmapsAerial = new ol.layer.Tile({
                title: 'BingMaps Aerial',
                source: new ol.source.BingMaps({
                    key: 'AnyGyd4GaAzToU0sDaA0NaXDD88yChcUh8ySoNc32_ddxkrxkl9K5SIATkA8EpMn',
                    imagerySet: 'AerialWithLabels'}),
                visible: false
            });

            /*Creacion capa base de OSM*/
            var osmLayer = new ol.layer.Tile({
                title: 'OpenStreetMaps',
                source: new ol.source.OSM(),
                visible: true
            });
            
            /*Creacion mapa*/
            var map = new ol.Map({
                target: 'map',        
                layers: [bmapsRoads],
                view: new ol.View({
                    center: [-8602509.5692, 134983.3435],
                    zoom: 14
                })
            });
            
            
            /*
             * 
             *CAPAS DE PRUEBA
             *
             */
            
            
            
            var vector = new ol.layer.Vector({
                source: new ol.source.Vector({wrapX: false}),
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(0, 255, 255, 0.2)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#2E9AFE',
                        width: 2
                    }),
                    image: new ol.style.Circle({
                        radius: 7,
                        fill: new ol.style.Fill({
                            color: '#ffcc33'
                        })
                    })
                })
            });
            
            
            map.addLayer(vector);

            /**
             * Dibujar areas
             */
            
            var draw;
            var isDrawingActive = false;
            
            function addInteraction() {
                geometryFunction = function (coordinates, geometry) {
                    if (!geometry) {
                        geometry = new ol.geom.Polygon(null);
                    }
                    var start = coordinates[0];
                    var end = coordinates[1];
                    geometry.setCoordinates([
                        [start, [start[0], end[1]], end, [end[0], start[1]], start]
                    ]);
                    return geometry;
                };
                draw = new ol.interaction.Draw({
                    source: vector.getSource(),
                    type: 'LineString',
                    geometryFunction: geometryFunction,
                    maxPoints: 2
                });
                map.addInteraction(draw);
            }

            function drawBox() {
                
                selectClick.getFeatures().clear();
                
                if(isSelectedActive){
                    map.removeInteraction(selectClick)
                    isSelectedActive = false;
                }
                
                
                
                isDrawingActive = !isDrawingActive;
                if (!isDrawingActive){
                    map.removeInteraction(draw);
                }else{
                    addInteraction();
                }
                
            }

            /**
             * Seleccionar areas
             */
            var select = null;
            var isSelectedActive = false;
            
            var selectClick = new ol.interaction.Select({
                condition: ol.events.condition.click,
                source: vector.getSource()
            });
            
            function selectFeatures(){
                
                if(isDrawingActive){
                    map.removeInteraction(draw);
                    isDrawingActive = false;
                }
                
                isSelectedActive = !isSelectedActive;
                if(!isSelectedActive){
                    map.removeInteraction(selectClick);
                    
                }else{
                    map.addInteraction(selectClick);
                }
            }
            
            selectClick.on('select', function(evt){
                var selected = evt.selected;
                var deselected = evt.deselected;

                if (selected.length) {
                    selected.forEach(function(feature){
                        console.info("SELECCIONADO");
                        //console.info(feature.getGeometry().getCoordinates());
                        var coordinates = feature.getGeometry().getCoordinates()[0];
                        
                        var coord = ""
                                    +"1." + coordinates[0] + "\n"
                                    +"2." + coordinates[1] + "\n"
                                    +"3." + coordinates[2] + "\n"
                                    +"4." + coordinates[3] + "\n"
                                    +"5." + coordinates[4] + "\n";
                        alert (coord);
                        
                    });
                } else {
                    deselected.forEach(function(feature){
                        console.info("NO SELECCIONADO");
                        console.info(feature);
                        
                    });
                }
            });
            
            /*
             * Limpiar capa de areas
             */
            function clearLayer() {
                selectClick.getFeatures().clear();
                vector.getSource().clear();
            }
            
            
        </script>
    </body>
</html>
